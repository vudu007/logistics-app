{% extends "base.html" %}
{% block title %}Schedule Logistics{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-11">
        
        <!-- MAIN CARD -->
        <div class="card shadow-lg border-0 mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-shipping-fast me-2 text-accent"></i>Mission Planner</span>
                <span class="badge bg-accent text-primary fw-bold">Automated Dispatch</span>
            </div>
            <div class="card-body p-4">
                
                <!-- TABS -->
                <ul class="nav nav-pills mb-4 justify-content-center" id="scheduleTab" role="tablist">
                    <li class="nav-item me-3">
                        <button class="nav-link active px-5 py-2 font-bold" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" type="button">
                            <i class="fas fa-truck me-2"></i>Single Trip
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link px-5 py-2 font-bold" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk" type="button">
                            <i class="fas fa-cubes me-2"></i>Multi-Store Bulk
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="scheduleTabContent">
                    
                    <!-- === 1. SINGLE TRIP (MANUAL) === -->
                    <div class="tab-pane fade show active" id="single" role="tabpanel">
                        <form method="POST">
                            <input type="hidden" name="schedule_type" value="single">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-gray-600">Select Truck</label>
                                    <select name="truck_id" id="truckSelect" class="form-select form-select-lg shadow-sm" required onchange="updateCapacity()">
                                        <option value="auto">âœ¨ Auto-Select (Balance Fleet)</option>
                                        <option disabled>----------------</option>
                                        {% for truck in trucks %}
                                        <option value="{{ truck.id }}" data-cap="{{ truck.capacity_tons }}">
                                            {{ truck.name }} (Cap: {{ truck.capacity_tons|int }} P) 
                                            â€” ðŸ‘¤ {{ truck.assigned_driver.name if truck.assigned_driver else 'No Driver' }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-gray-600">Destination</label>
                                    <select name="store_id" class="form-select form-select-lg store-select shadow-sm" required>
                                        <option value="" disabled selected>Search Store...</option>
                                        {% for store in stores %}
                                        <option value="{{ store.id }}">{{ store.name }} - {{ store.address }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-5 mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                                <label class="form-label fw-bold text-gray-700">Load Weight (Pallets)</label>
                                <div class="input-group input-group-lg mb-2">
                                    <input type="number" step="0.1" name="load_weight" id="loadInput" class="form-control" placeholder="Enter pallets..." required oninput="updateGauge()">
                                    <span class="input-group-text bg-primary text-white border-primary">Pallets</span>
                                </div>
                                <div class="progress" style="height: 25px; border-radius: 12px; background-color: #e2e8f0;">
                                    <div id="loadBar" class="progress-bar bg-success transition-all duration-500" role="progressbar" style="width: 0%">0%</div>
                                </div>
                                <small id="capText" class="text-muted fw-semibold">Select a truck to check limits.</small>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label class="fw-bold text-gray-600">Departure Time</label>
                                    <input type="datetime-local" name="start_time" class="form-control form-control-lg start-time-input shadow-sm" required>
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-5">
                                <button type="submit" id="submitBtn" class="btn btn-success btn-lg py-3 fw-bold shadow hover:bg-green-600">
                                    <i class="fas fa-check-circle me-2"></i> Confirm Schedule
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- === 2. BULK DISPATCH === -->
                    <div class="tab-pane fade" id="bulk" role="tabpanel">
                        
                        <!-- JOB UPLOADER CARD -->
                        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-4">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div class="flex items-center">
                                    <div class="bg-indigo-100 p-3 rounded-full mr-4 text-indigo-600">
                                        <i class="fas fa-file-upload fa-lg"></i>
                                    </div>
                                    <div>
                                        <h5 class="font-bold text-indigo-900 mb-1">Job Uploader</h5>
                                        <p class="text-xs text-indigo-700 m-0">
                                            1. <a href="{{ url_for('download_job_template') }}" class="underline font-bold hover:text-indigo-900">Download Template</a>.<br>
                                            2. Fill "Pallets". 3. Upload to auto-fill list.
                                        </p>
                                    </div>
                                </div>
                                <div class="flex gap-2 w-full md:w-auto">
                                    <a href="{{ url_for('download_job_template') }}" class="btn btn-outline-indigo btn-sm bg-white text-indigo-700 border-indigo-300 hover:bg-indigo-50 fw-bold whitespace-nowrap">
                                        <i class="fas fa-download me-1"></i> Template
                                    </a>
                                    
                                    <form action="{{ url_for('upload_job_manifest') }}" method="POST" enctype="multipart/form-data" class="flex gap-2">
                                        <input type="file" name="file" class="form-control form-control-sm" accept=".xlsx, .xls" required style="width: 200px;">
                                        <button type="submit" class="btn btn-indigo bg-indigo-600 text-white btn-sm fw-bold whitespace-nowrap hover:bg-indigo-700">
                                            <i class="fas fa-upload me-1"></i> Upload
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- BULK FORM -->
                        <form method="POST" action="{{ url_for('schedule_truck') }}">
                            <input type="hidden" name="schedule_type" value="bulk">
                            
                            <!-- Master Select for Cloning -->
                            <select id="storeMasterSelect" style="display:none;">
                                <option value="" disabled selected>Search Store...</option>
                                {% for store in stores %}
                                <option value="{{ store.id }}">{{ store.name }} - {{ store.address }}</option>
                                {% endfor %}
                            </select>

                            <!-- ROWS CONTAINER -->
                            <div id="storeRows">
                                <!-- JS inserts rows here -->
                            </div>

                            <div class="mb-4 mt-3 d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary border-2 fw-bold" onclick="addStoreRow()">
                                    <i class="fas fa-plus-circle me-1"></i> Add Manual Row
                                </button>
                                <button type="button" class="btn btn-outline-danger border-2 fw-bold" onclick="clearManifest()">
                                    <i class="fas fa-trash me-1"></i> Clear List
                                </button>
                            </div>

                            <hr class="my-4">

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="fw-bold text-gray-600">Start Dispatching At</label>
                                    <input type="datetime-local" name="start_time" class="form-control form-control-lg start-time-input shadow-sm" required>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-warning btn-lg py-3 fw-bold shadow text-gray-900 hover:bg-yellow-500">
                                    <i class="fas fa-magic me-2"></i> Generate & Assign Trips
                                </button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="previewModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-check-circle me-2"></i>Confirm Uploaded Jobs</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="alert alert-light m-3 border-start border-success border-4 text-sm">
                    The following stores were found in your Excel file. Click <strong>Confirm & Add</strong> to populate the planner.
                </div>
                <table class="table table-striped mb-0">
                    <thead class="table-dark"><tr><th>Store Name</th><th>Address</th><th>Pallets</th></tr></thead>
                    <tbody id="previewTableBody"></tbody>
                </table>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success fw-bold" onclick="confirmUpload()">
                    <i class="fas fa-plus-circle me-1"></i> Confirm & Add to Planner
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Variables
    let uploadedData = [];
    var previewModalInstance; // Global variable for modal

    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const timeStr = now.toISOString().slice(0, 16);
        document.querySelectorAll('.start-time-input').forEach(input => { input.value = timeStr; });

        initTomSelect();

        // --- PREVIEW LOGIC ---
        {% if preview_jobs %}
            const bulkTab = new bootstrap.Tab(document.querySelector('#bulk-tab'));
            bulkTab.show();

            uploadedData = {{ preview_jobs | tojson }};
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';
            uploadedData.forEach(job => {
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${job.store_name}</td>
                        <td class="small text-muted">${job.store_address}</td>
                        <td class="fw-bold text-success">${job.volume}</td>
                    </tr>
                `;
            });

            // Show Modal and store instance
            const modalEl = document.getElementById('previewModal');
            previewModalInstance = new bootstrap.Modal(modalEl);
            previewModalInstance.show();
        {% else %}
            addStoreRow();
        {% endif %}
    });

    // --- FIX: FORCE MODAL CLOSE & BATCH ADD ---
    function confirmUpload() {
        const container = document.getElementById('storeRows');
        container.innerHTML = ''; // Clear existing list
        
        // Add rows (without initializing TomSelect yet for speed)
        uploadedData.forEach(job => {
            addStoreRow(job.store_id, job.volume, false); 
        });

        // Initialize all TomSelects at once
        initTomSelect();

        // Close Modal Properly
        if(previewModalInstance) {
            previewModalInstance.hide();
        }
        
        // Force cleanup of backdrop if it gets stuck
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style = '';
    }

    function clearManifest() {
        if(confirm("Are you sure you want to clear all stores from the list?")) {
            document.getElementById('storeRows').innerHTML = '';
            addStoreRow(); // Add one empty row back
        }
    }

    function initTomSelect() {
        document.querySelectorAll('.store-select').forEach(el => {
            if (!el.tomselect) {
                new TomSelect(el, {
                    create: false,
                    sortField: { field: "text", direction: "asc" },
                    placeholder: "Type to search store...",
                    maxOptions: 100
                });
            }
        });
    }

    function addStoreRow(storeId = null, volume = '', doInit = true) {
        const container = document.getElementById('storeRows');
        const masterSelect = document.getElementById('storeMasterSelect');
        const newRow = document.createElement('div');
        newRow.className = 'row mb-3 store-row p-3 border rounded bg-white shadow-sm align-items-center fade-in';
        newRow.innerHTML = `
            <div class="col-md-8">
                <label class="form-label fw-bold text-gray-600">Destination Store</label>
                <select name="store_ids[]" class="form-select store-select" required>
                    ${masterSelect.innerHTML}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold text-gray-600">Order (Pallets)</label>
                <input type="number" step="1" name="volumes[]" class="form-control" placeholder="e.g. 500" value="${volume}" required>
            </div>
            <div class="col-md-1 text-center">
                <button type="button" class="btn btn-danger btn-sm rounded-circle p-2 mt-4 shadow-sm" onclick="this.closest('.row').remove()"><i class="fas fa-times"></i></button>
            </div>
        `;
        container.appendChild(newRow);
        
        if (storeId) {
            const sel = newRow.querySelector('select');
            sel.value = storeId;
        }

        if (doInit) {
            initTomSelect();
        }
    }

    function updateCapacity() { updateGauge(); }
    function updateGauge() {
        const truckSelect = document.getElementById('truckSelect');
        const loadInput = document.getElementById('loadInput');
        const progressBar = document.getElementById('loadBar');
        const capText = document.getElementById('capText');
        const submitBtn = document.getElementById('submitBtn');
        const selectedOption = truckSelect.options[truckSelect.selectedIndex];
        
        if (selectedOption.value === "auto") {
            progressBar.style.width = '100%';
            progressBar.className = 'progress-bar bg-info progress-bar-striped progress-bar-animated';
            progressBar.innerText = 'Auto';
            capText.innerText = "System picks best truck.";
            submitBtn.disabled = false;
            return;
        }

        const maxCap = parseFloat(selectedOption.getAttribute('data-cap')) || 0;
        const currentLoad = parseFloat(loadInput.value) || 0;

        if (maxCap === 0) {
            progressBar.style.width = '0%';
            return;
        }

        const percentage = (currentLoad / maxCap) * 100;
        progressBar.style.width = Math.min(percentage, 100) + '%';
        progressBar.innerText = percentage.toFixed(0) + '%';

        if (percentage > 100) {
            progressBar.className = 'progress-bar bg-danger progress-bar-striped';
            capText.innerText = `OVERLOAD! Max ${maxCap}`;
            capText.className = "text-danger fw-bold";
            submitBtn.disabled = true;
        } else {
            progressBar.className = 'progress-bar bg-success';
            capText.innerText = `Safe Load (${maxCap} P)`;
            capText.className = "text-success fw-bold";
            submitBtn.disabled = false;
        }
    }
</script>

<style>
    .nav-pills .nav-link.active { background-color: #f59e0b !important; color: #0f172a !important; }
    .nav-pills .nav-link { color: #64748b; background-color: #f1f5f9; }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .btn-indigo { background-color: #4f46e5; color: white; }
    .btn-outline-indigo { color: #4f46e5; border-color: #4f46e5; }
    .btn-outline-indigo:hover { background-color: #4f46e5; color: white; }
</style>
{% endblock %}